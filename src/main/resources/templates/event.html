<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ì„ ì°©ìˆœ ì´ë²¤íŠ¸</title>
    <link href="/main.css" rel="stylesheet">
    <style>
        /* ì´ë²¤íŠ¸ í˜ì´ì§€ ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ cssê°€ ê¹¨ì§€ì§€ ì•Šê²Œ) */
        .event-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            justify-content: center;
        }
        .status-log {
            background-color: #333;
            color: #0f0;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            height: 150px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 14px;
        }
        .stress-test-box {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            color: #721c24;
        }
        .btn-join {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div th:replace="~{ nav.html::navbar }"></div>

<div class="stress-test-box">
    <h3>ğŸ”¥ ê°œë°œì í…ŒìŠ¤íŠ¸ ë„êµ¬: ë™ì‹œì„± ê²€ì¦</h3>
    <p>ë²„íŠ¼ í´ë¦­ ì‹œ 100ëª…ì˜ ì‚¬ìš©ìê°€ ë™ì‹œì— 'ì´ë²¤íŠ¸ A'ì— ì°¸ì—¬ë¥¼ ì‹œë„í•©ë‹ˆë‹¤. (Redisson Lock ë™ì‘ í™•ì¸ìš©)</p>
    <button class="btn-danger" onclick="stressTest()">100ëª… ë™ì‹œ ì ‘ì† ì‹œì‘</button>
</div>

<div id="logArea" class="status-log">
    <div>[System] ì¤€ë¹„ ì™„ë£Œ... ì´ë²¤íŠ¸ ëª©ë¡ì€ Redis ìºì‹œ(Lettuce)ì—ì„œ ë¡œë”©ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
</div>

<div class="event-container">
    <div class="card" th:each="event : ${events}">
        <img src="https://placehold.co/300x200" alt="img" />
        <div style="padding: 15px;">
            <h4 th:text="${event.title}">ì œëª©</h4>
            <p>ì´ <span th:text="${event.limitCount}"></span>ëª… í•œì •</p>
            <p style="color: red;">í˜„ì¬ ì”ì—¬: <span th:text="${event.remainCount}"></span>ê°œ</p>

            <button class="btn-join"
                    th:data-id="${event.id}"
                    th:data-title="${event.title}"
                    onclick="applyEvent(this.getAttribute('data-id'), this.getAttribute('data-title'))">
                ì„ ì°©ìˆœ ì‹ ì²­
            </button>
        </div>
    </div>
</div>
<script>
    // ë¡œê·¸ ì¶œë ¥ ìœ í‹¸
    function log(msg) {
        const area = document.getElementById('logArea');
        const line = document.createElement('div');
        line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        area.prepend(line);
    }

    async function applyEvent(eventId, eventTitle) {
        const userId = 'user_' + Math.floor(Math.random() * 1000);
        log(`â³ [${eventTitle}] ì‹ ì²­ ì‹œë„...`);

        // eventIdë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ì†¡
        const response = await fetch(`/apply?eventId=${eventId}&userId=${userId}`);
        const result = await response.text();

        if(result.includes("ì„±ê³µ")) log(`âœ… ${result}`);
        else log(`âŒ ${result}`);
    }

    function stressTest() {
        // IDê°€ 1ë²ˆì¸ ìƒí’ˆ(ë§¥ë¶)ì— 100ëª… í­ì£¼ì‹œí‚¤ê¸°
        const targetEventId = 1;
        log("âš ï¸ 1ë²ˆ ì´ë²¤íŠ¸(ë§¥ë¶)ì— 100ëª… ë™ì‹œ ìš”ì²­ ì‹œì‘!");

        for (let i = 0; i < 100; i++) {
            fetch(`/apply?eventId=${targetEventId}&userId=tester_${i}`)
                .then(res => res.text())
                .then(text => {
                    if(text.includes("ì„±ê³µ")) log(`ğŸ‰ ë‹¹ì²¨! (${text})`);
                });
        }
    }
</script>
</body>
</html>